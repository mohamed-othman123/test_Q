<div
  class="magical-chat-container"
  [attr.data-theme]="theme()"
  [class.sidebar-collapsed]="sidebarCollapsed()">
  <!-- Enhanced Sidebar -->
  <aside
    class="chat-sidebar"
    [class.collapsed]="sidebarCollapsed()"
    [@sidebarSlide]="sidebarCollapsed() ? 'collapsed' : 'expanded'">
    <div class="sidebar-header">
      <div class="logo-section">
        <div class="app-logo" [@magicalAppear]>
          <div class="logo-icon">
            <i class="pi pi-sparkles"></i>
          </div>
          <span class="logo-text" *ngIf="!sidebarCollapsed()" [@fadeInUp]
            >AI Assistant</span
          >
        </div>
        <button
          class="collapse-btn btn-magical"
          (click)="toggleSidebar()"
          [title]="sidebarCollapsed() ? 'Expand Sidebar' : 'Collapse Sidebar'">
          <i
            class="pi"
            [class.pi-chevron-left]="!sidebarCollapsed()"
            [class.pi-chevron-right]="sidebarCollapsed()"></i>
        </button>
      </div>

      <button
        class="new-chat-btn btn-magical"
        (click)="startNewConversation()"
        *ngIf="!sidebarCollapsed()"
        [@fadeInUp]>
        <i class="pi pi-plus"></i>
        New Chat
      </button>
    </div>

    <div class="conversations-list" *ngIf="!sidebarCollapsed()">
      <div class="conversations-header">
        <h3>Recent Conversations</h3>
        <button
          class="refresh-btn"
          (click)="loadConversations()"
          [class.loading]="isLoadingConversations">
          <i class="pi pi-refresh" [class.pi-spin]="isLoadingConversations"></i>
        </button>
      </div>

      <div [@listStagger]>
        <div
          class="conversation-item stagger-item"
          *ngFor="let conv of conversations(); trackBy: trackConversation"
          [class.active]="currentConversationId() === conv.id"
          (click)="selectConversation(conv.id)">
          <div class="conversation-preview">
            <div class="conversation-topic">
              {{ conv.topic || 'General Chat' }}
            </div>
            <div class="conversation-time">
              {{ formatConversationTime(conv.lastMessageAt) }}
            </div>
          </div>
          <div class="conversation-meta">
            <i
              class="pi pi-circle-fill activity-indicator"
              *ngIf="isRecentActivity(conv.lastMessageAt)"></i>
          </div>
        </div>
      </div>

      <div
        class="conversations-empty"
        *ngIf="conversations().length === 0 && !isLoadingConversations"
        [@fadeInUp]>
        <i class="pi pi-comment"></i>
        <p>No conversations yet. Start chatting!</p>
      </div>
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="main-chat-area">
    <!-- Enhanced Header -->
    <header class="chat-header">
      <div class="header-content">
        <div class="chat-title">
          <div class="title-icon" [@magicalAppear]>
            <i class="pi pi-brain" *ngIf="!isLoading()"></i>
            <i class="pi pi-spinner pi-spin" *ngIf="isLoading()"></i>
          </div>
          <div class="title-text">
            <h2>{{ getCurrentConversationTitle() }}</h2>
            <p class="subtitle">{{ getSubtitleText() }}</p>
          </div>
        </div>

        <div class="header-actions">
          <button
            class="action-btn btn-magical"
            (click)="clearCurrentConversation()"
            [disabled]="messages().length === 0"
            title="Clear conversation">
            <i class="pi pi-trash"></i>
          </button>
          <button
            class="action-btn btn-magical"
            (click)="toggleTheme()"
            [title]="
              theme() === 'dark'
                ? 'Switch to light mode'
                : 'Switch to dark mode'
            ">
            <i
              class="pi"
              [class.pi-sun]="theme() === 'dark'"
              [class.pi-moon]="theme() === 'light'"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Messages Container -->
    <section class="messages-container">
      <div class="messages-area" #messagesContainer>
        <div class="messages-wrapper">
          <!-- Welcome Section -->
          <div
            class="welcome-section"
            *ngIf="messages().length === 0 && !isLoading()"
            [@magicalAppear]>
            <div class="welcome-card">
              <div class="welcome-icon">
                <i class="pi pi-sparkles"></i>
              </div>
              <h3>Welcome to AI Assistant</h3>
              <p>
                Ask me anything about your business analytics, halls, bookings,
                or get insights from your data.
              </p>

              <div class="quick-starters" [@listStagger]>
                <button
                  class="starter-card stagger-item btn-magical"
                  (click)="sendQuickMessage('Show me our revenue trends')">
                  <i class="pi pi-chart-line"></i>
                  <span>Revenue Analytics</span>
                </button>
                <button
                  class="starter-card stagger-item btn-magical"
                  (click)="
                    sendQuickMessage('What are our top performing halls?')
                  ">
                  <i class="pi pi-building"></i>
                  <span>Hall Performance</span>
                </button>
                <button
                  class="starter-card stagger-item btn-magical"
                  (click)="sendQuickMessage('Summarize recent bookings')">
                  <i class="pi pi-calendar"></i>
                  <span>Booking Summary</span>
                </button>
                <button
                  class="starter-card stagger-item btn-magical"
                  (click)="sendQuickMessage('Customer insights and trends')">
                  <i class="pi pi-users"></i>
                  <span>Customer Insights</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Messages Thread -->
          <div
            class="message-wrapper"
            *ngFor="let message of messages(); trackBy: trackMessage"
            [@messageAnimation]>
            <!-- User Message -->
            <div class="message user-message" *ngIf="message.type === 'user'">
              <div class="message-content">
                <div class="message-bubble">
                  <div class="message-text">{{ message.message }}</div>
                  <div class="message-meta">
                    <span class="timestamp">{{
                      formatTime(message.timestamp)
                    }}</span>
                    <span
                      class="hall-context"
                      *ngIf="message.hallIds && message.hallIds.length > 0">
                      <i class="pi pi-building"></i>
                      {{ message.hallIds.length }}
                      {{ message.hallIds.length === 1 ? 'hall' : 'halls' }}
                    </span>
                    <div class="status-indicator">
                      <i
                        class="status-icon pi"
                        [class.pi-clock]="message.status === 'sending'"
                        [class.pi-check]="message.status === 'sent'"
                        [class.pi-check-circle]="message.status === 'delivered'"
                        [class.pi-times-circle]="message.status === 'failed'"
                        [class.sending]="message.status === 'sending'"
                        [class.sent]="message.status === 'sent'"
                        [class.delivered]="message.status === 'delivered'"
                        [class.failed]="message.status === 'failed'"></i>
                    </div>
                  </div>
                </div>
              </div>
              <div class="message-avatar">
                <div class="user-avatar">
                  <i class="pi pi-user"></i>
                </div>
              </div>
            </div>

            <!-- Assistant Message -->
            <div
              class="message assistant-message"
              *ngIf="message.type === 'assistant'">
              <div class="message-avatar">
                <div
                  class="ai-avatar"
                  [class.thinking]="message.isLoading || message.isStreaming">
                  <i
                    class="pi pi-brain"
                    *ngIf="!message.isLoading && !message.isStreaming"></i>
                  <i
                    class="pi pi-spinner pi-spin"
                    *ngIf="message.isLoading || message.isStreaming"></i>
                </div>
              </div>
              <div class="message-content">
                <div
                  class="message-bubble"
                  [class.loading]="message.isLoading"
                  [class.streaming]="message.isStreaming"
                  [class.error]="message.error">
                  <!-- Typing Indicator -->
                  <div
                    class="typing-indicator"
                    *ngIf="
                      message.isStreaming &&
                      !message.streamingContent &&
                      !message.message
                    ">
                    <div class="typing-dots">
                      <span></span><span></span><span></span>
                    </div>
                    <span class="typing-text">AI is thinking...</span>
                  </div>

                  <!-- Streaming Content -->
                  <div
                    class="message-text streaming-text"
                    *ngIf="
                      message.isStreaming &&
                      (message.streamingContent || message.message)
                    "
                    [innerHTML]="
                      renderMarkdown(
                        message.streamingContent || message.message
                      )
                    "></div>

                  <!-- Final Content -->
                  <div
                    class="message-text"
                    *ngIf="
                      !message.isStreaming &&
                      !message.isLoading &&
                      message.message &&
                      !message.error
                    "
                    [innerHTML]="renderMarkdown(message.message)"></div>

                  <!-- Chart/Visualization -->
                  <div
                    class="chart-container"
                    *ngIf="message.chartUrl && !message.error"
                    [@fadeInUp]>
                    <iframe
                      [src]="message.chartUrl"
                      class="chart-frame"
                      style="border: none">
                    </iframe>
                  </div>

                  <!-- Error State -->
                  <div class="error-content" *ngIf="message.error" [@fadeInUp]>
                    <i class="pi pi-exclamation-triangle"></i>
                    <span>{{ message.error }}</span>
                    <button
                      class="retry-btn btn-magical"
                      (click)="retryMessage(message)">
                      <i class="pi pi-refresh"></i> Retry
                    </button>
                  </div>
                </div>

                <!-- Message Actions -->
                <div
                  class="message-meta"
                  *ngIf="
                    !message.isLoading && !message.isStreaming && !message.error
                  ">
                  <span class="timestamp">{{
                    formatTime(message.timestamp)
                  }}</span>
                  <div class="message-actions">
                    <button
                      class="action-btn btn-magical"
                      (click)="copyMessage(message.message || '')"
                      title="Copy message">
                      <i class="pi pi-copy"></i>
                    </button>
                    <button
                      class="action-btn btn-magical"
                      (click)="regenerateResponse(message)"
                      title="Regenerate response"
                      *ngIf="message.type === 'assistant'">
                      <i class="pi pi-refresh"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Enhanced Input Area -->
    <footer class="chat-input-container">
      <form [formGroup]="chatForm" (ngSubmit)="onSubmit()" class="chat-form">
        <div
          class="input-wrapper"
          [class.focused]="isInputFocused()"
          [class.has-content]="messageText().length > 0">
          <!-- Context Indicators -->
          <div
            class="context-indicators"
            *ngIf="getCurrentHallName() || currentConversationId()">
            <div class="context-pill" *ngIf="getCurrentHallName()">
              <i class="pi pi-building"></i>
              <span>{{ getCurrentHallName() }}</span>
            </div>
            <div class="context-pill" *ngIf="currentConversationId()">
              <i class="pi pi-history"></i>
              <span>{{ getCurrentConversationTitle() }}</span>
            </div>
          </div>

          <div class="message-input-group">
            <textarea
              #messageInput
              formControlName="message"
              class="message-input"
              [placeholder]="getInputPlaceholder()"
              rows="1"
              (keydown)="onKeydown($event)"
              (input)="onInputChange($event)"
              (focus)="isInputFocused.set(true)"
              (blur)="isInputFocused.set(false)"
              maxlength="2000"></textarea>

            <div class="input-actions">
              <button
                type="button"
                class="action-btn btn-magical"
                title="Voice Input"
                (click)="toggleVoiceInput()"
                [class.recording]="isRecording()"
                [disabled]="isLoading()">
                <i class="pi pi-microphone"></i>
              </button>

              <button
                type="submit"
                class="send-btn btn-magical"
                [disabled]="!canSendMessage()"
                [class.sending]="isLoading()">
                <i class="pi pi-send" *ngIf="!isLoading()"></i>
                <i class="pi pi-spinner pi-spin" *ngIf="isLoading()"></i>
              </button>
            </div>
          </div>

          <!-- Character Counter -->
          <div class="input-meta" *ngIf="messageText().length > 0">
            <div class="char-counter">
              <span
                class="char-count"
                [class.warning]="messageText().length > 1800"
                [class.danger]="messageText().length >= 2000">
                {{ messageText().length }}/2000
              </span>
              <div class="char-progress">
                <div
                  class="char-progress-bar"
                  [style.width.%]="(messageText().length / 2000) * 100"
                  [class.warning]="messageText().length > 1800"
                  [class.danger]="messageText().length >= 2000"></div>
              </div>
            </div>
          </div>
        </div>
      </form>

      <!-- Quick Actions -->
      <div
        class="quick-actions"
        *ngIf="!isLoading() && messages().length === 0"
        [@listStagger]>
        <button
          class="quick-action btn-magical stagger-item"
          (click)="onQuickAction('revenue')">
          <i class="pi pi-chart-bar"></i>
          <span>Revenue Analytics</span>
        </button>
        <button
          class="quick-action btn-magical stagger-item"
          (click)="onQuickAction('bookings')">
          <i class="pi pi-calendar"></i>
          <span>Booking Insights</span>
        </button>
        <button
          class="quick-action btn-magical stagger-item"
          (click)="onQuickAction('customers')">
          <i class="pi pi-users"></i>
          <span>Customer Analysis</span>
        </button>
        <button
          class="quick-action btn-magical stagger-item"
          (click)="onQuickAction('performance')">
          <i class="pi pi-analytics"></i>
          <span>Performance KPIs</span>
        </button>
      </div>

      <!-- Smart Suggestions -->
      <div
        class="smart-suggestions"
        *ngIf="smartSuggestions().length > 0 && !isLoading()"
        [@fadeInUp]>
        <div class="suggestions-header">
          <i class="pi pi-lightbulb"></i>
          <span>Smart suggestions:</span>
        </div>
        <div class="suggestions-list" [@listStagger]>
          <button
            class="suggestion-chip btn-magical stagger-item"
            *ngFor="let suggestion of smartSuggestions()"
            (click)="sendQuickMessage(suggestion)">
            {{ suggestion }}
          </button>
        </div>
      </div>
    </footer>
  </main>
</div>
