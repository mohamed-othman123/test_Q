<div class="ai-chat-container">
  <div class="chat-header">
    <div class="header-content">
      <div class="chat-title">
        <div class="title-icon">
          <i class="pi pi-brain" *ngIf="!isLoading"></i>
          <i class="pi pi-spin pi-spinner" *ngIf="isLoading"></i>
        </div>
        <div class="title-text">
          <h2>{{ 'analytics.aiChat.title' | translate }}</h2>
          <p class="subtitle">{{ 'analytics.aiChat.subtitle' | translate }}</p>
        </div>
      </div>

      <div class="context-selector" *ngIf="availableHalls.length > 0">
        <button
          class="context-toggle-btn"
          [class.active]="showHallSelector"
          [class.current-hall-active]="isUsingCurrentHall()"
          (click)="showHallSelector = !showHallSelector"
          pButton
          type="button">
          <i class="pi pi-building"></i>
          <span class="hall-count">{{ getEffectiveHallIds().length }}</span>
          <span class="hall-text">{{ getContextDisplayText() }}</span>
          <i
            class="pi pi-star-fill current-hall-indicator"
            *ngIf="isUsingCurrentHall()"
            title="Current hall included"></i>
          <i class="pi pi-chevron-down" [class.rotated]="showHallSelector"></i>
        </button>

        <div class="hall-selector" *ngIf="showHallSelector" [@slideDown]>
          <div class="selector-header">
            <div class="header-text">
              <i class="pi pi-building"></i>
              <span>{{ 'analytics.aiChat.selectHalls' | translate }}</span>
              <span class="current-hall-info" *ngIf="currentHallId">
                <i class="pi pi-star"></i>
                Current: {{ currentHallId }}
              </span>
            </div>
            <div class="header-actions">
              <button
                class="action-btn select-all"
                (click)="selectAllHalls()"
                [disabled]="selectedHallIds.length === availableHalls.length">
                <i class="pi pi-check-circle"></i>
                {{ 'analytics.aiChat.selectAll' | translate }}
              </button>
              <button
                class="action-btn clear-all"
                (click)="clearHallSelection()"
                [disabled]="selectedHallIds.length === 0">
                <i class="pi pi-times-circle"></i>
                {{ 'analytics.aiChat.clearAll' | translate }}
              </button>
            </div>
          </div>

          <div class="hall-options">
            <div
              class="hall-option"
              *ngFor="let hall of availableHalls; trackBy: trackHall"
              [class.selected]="selectedHallIds.includes(hall.id)"
              [class.current-hall]="hall.id === currentHallId"
              (click)="toggleHallSelection(hall.id)">
              <div class="hall-checkbox">
                <i
                  class="pi"
                  [ngClass]="
                    selectedHallIds.includes(hall.id)
                      ? 'pi-check-square'
                      : 'pi-square'
                  "></i>
              </div>

              <div class="hall-info">
                <div class="hall-name">
                  {{ hall.name }}
                  <span class="current-badge" *ngIf="hall.id === currentHallId"
                    >Current</span
                  >
                </div>
                <div class="hall-id">ID: {{ hall.id }}</div>
              </div>

              <div
                class="selection-indicator"
                *ngIf="selectedHallIds.includes(hall.id)">
                <i class="pi pi-check"></i>
              </div>
            </div>
          </div>

          <div class="selector-footer">
            <div
              class="context-indicator"
              *ngIf="getEffectiveHallIds().length > 0">
              <i class="pi pi-building"></i>
              <span>{{ getContextDisplayText() }}</span>
              <i
                class="pi pi-star current-hall-star"
                *ngIf="isUsingCurrentHall()"></i>
            </div>

            <div
              class="current-hall-guarantee"
              *ngIf="currentHallId && selectedHallIds.length === 0">
              <i class="pi pi-shield"></i>
              <span>{{
                'analytics.aiChat.context.currentHallOnly' | translate
              }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-messages-container" #messagesContainer>
    <div class="chat-loading" *ngIf="isInitializing">
      <div class="loading-content">
        <i class="pi pi-spin pi-spinner"></i>
        <p>{{ 'analytics.aiChat.states.initializing' | translate }}</p>
      </div>
    </div>

    <div class="chat-messages" *ngIf="!isInitializing">
<!--      <div class="sample-prompts" *ngIf="messages.length <= 1">-->
<!--        <h3>{{ 'analytics.aiChat.prompts.title' | translate }}</h3>-->
<!--        <div class="prompt-cards">-->
<!--          <div-->
<!--            class="prompt-card"-->
<!--            *ngFor="let prompt of getSamplePrompts()"-->
<!--            (click)="onSamplePromptClick(prompt)">-->
<!--            <i class="pi pi-lightbulb"></i>-->
<!--            <span>{{ prompt }}</span>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->

      <div
        class="message-wrapper"
        *ngFor="let message of messages; trackBy: trackMessage">
        <div
          class="message user-message"
          *ngIf="message.type === 'user'"
          [@fadeInUp]>
          <div class="message-content">
            <div class="message-bubble">
              <p>{{ message.message }}</p>
              <div class="message-meta">
                <span class="timestamp">{{
                  formatTime(message.timestamp)
                }}</span>
                <span class="hall-context" *ngIf="message.hallIds.length > 0">
                  <i class="pi pi-building"></i>
                  {{ message.hallIds.length }} halls
                </span>
              </div>
            </div>
          </div>
          <div class="message-avatar">
            <i class="pi pi-user"></i>
          </div>
        </div>

        <div
          class="message assistant-message"
          *ngIf="message.type === 'assistant'"
          [@fadeInUp]>
          <div class="message-avatar">
            <i class="pi pi-brain" *ngIf="!message.isLoading"></i>
            <i class="pi pi-spin pi-spinner" *ngIf="message.isLoading"></i>
          </div>
          <div class="message-content">
            <div
              class="message-bubble"
              [class.loading]="message.isLoading"
              [class.error]="message.error">
              <div class="loading-indicator" *ngIf="message.isLoading">
                <div class="loading-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <p>{{ message.message }}</p>
              </div>

              <div
                class="error-content"
                *ngIf="message.error && !message.isLoading">
                <i class="pi pi-exclamation-triangle"></i>
                <p>{{ message.message }}</p>
                <button class="retry-btn" pButton type="button" size="small">
                  <i class="pi pi-refresh"></i>
                  {{ 'analytics.aiChat.states.retry' | translate }}
                </button>
              </div>

              <div
                class="normal-content"
                *ngIf="!message.isLoading && !message.error">
                <p>{{ message.message }}</p>

                <div class="chart-container" *ngIf="message.chartUrl">
                  <div class="chart-header">
                    <i class="pi" [ngClass]="getVisualizationIcon()"></i>
                    <span>{{
                      'analytics.aiChat.chart.title' | translate
                    }}</span>
                  </div>
                  <div class="chart-iframe-wrapper">
                    <iframe
                      [src]="message.chartUrl"
                      frameborder="0"
                      class="chart-iframe">
                    </iframe>
                    <div class="chart-overlay">
                      <button
                        class="fullscreen-btn"
                        pButton
                        type="button"
                        size="small">
                        <i class="pi pi-external-link"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <div class="message-meta">
                  <span class="timestamp">{{
                    formatTime(message.timestamp)
                  }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-input-container">
    <form [formGroup]="chatForm" (ngSubmit)="onSubmit()" class="chat-form">
      <div class="input-wrapper">
        <div class="context-indicator" *ngIf="selectedHallIds.length > 0">
          <i class="pi pi-building"></i>
          <span>{{ selectedHallIds.length }} halls</span>
        </div>

        <div class="message-input-group">
          <textarea
            #messageInput
            formControlName="message"
            class="message-input"
            [placeholder]="'analytics.aiChat.placeholder' | translate"
            rows="1"
            (keydown)="onKeydown($event)"
            (input)="autoResizeTextarea($event)"
            [disabled]="isLoading">
          </textarea>

          <button
            type="submit"
            class="send-btn"
            [disabled]="chatForm.invalid || isLoading"
            pButton>
            <i class="pi pi-send" *ngIf="!isLoading"></i>
            <i class="pi pi-spin pi-spinner" *ngIf="isLoading"></i>
          </button>
        </div>

        <div class="input-actions">
          <button
            type="button"
            class="action-btn"
            title="Attach Context"
            pButton>
            <i class="pi pi-paperclip"></i>
          </button>

          <button type="button" class="action-btn" title="Voice Input" pButton>
            <i class="pi pi-microphone"></i>
          </button>
        </div>
      </div>

      <div
        class="form-errors"
        *ngIf="
          chatForm.get('message')?.errors && chatForm.get('message')?.touched
        ">
        <small
          class="error-text"
          *ngIf="chatForm.get('message')?.errors?.['required']">
          {{ 'analytics.aiChat.validation.required' | translate }}
        </small>
        <small
          class="error-text"
          *ngIf="chatForm.get('message')?.errors?.['minlength']">
          {{ 'analytics.aiChat.validation.minLength' | translate }}
        </small>
      </div>
    </form>

    <div class="quick-actions" *ngIf="!isLoading">
      <button
        class="quick-action"
        pButton
        type="button"
        size="small"
        (click)="onQuickAction('revenue')">
        <i class="pi pi-chart-bar"></i>
        {{ 'analytics.aiChat.quickActions.revenue' | translate }}
      </button>
      <button
        class="quick-action"
        pButton
        type="button"
        size="small"
        (click)="onQuickAction('bookings')">
        <i class="pi pi-calendar"></i>
        {{ 'analytics.aiChat.quickActions.bookings' | translate }}
      </button>
      <button
        class="quick-action"
        pButton
        type="button"
        size="small"
        (click)="onQuickAction('customers')">
        <i class="pi pi-users"></i>
        {{ 'analytics.aiChat.quickActions.customers' | translate }}
      </button>
    </div>
  </div>
</div>
